{"version":3,"sources":["../../src/pages/payment-modal/payment-modal.module.ts","../../src/pages/payment-modal/payment-modal.ts"],"names":[],"mappings":"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","file":"3.js","sourcesContent":["import { NgModule } from \"@angular/core\";\nimport { IonicPageModule } from \"ionic-angular\";\nimport { PaymentModalPage } from \"./payment-modal\";\n\n@NgModule({\n  declarations: [PaymentModalPage],\n  imports: [IonicPageModule.forChild(PaymentModalPage)]\n})\nexport class PaymentModalPageModule {}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/payment-modal/payment-modal.module.ts","import { Component } from \"@angular/core\";\nimport {\n  IonicPage,\n  NavParams,\n  ViewController,\n  AlertController,\n  Card,\n  ToastController\n} from \"ionic-angular\";\nimport { AngularFireDatabase } from \"angularfire2/database\";\nimport { AES256 } from \"@ionic-native/aes-256\";\n\n@IonicPage()\n@Component({\n  selector: \"page-payment-modal\",\n  templateUrl: \"payment-modal.html\"\n})\nexport class PaymentModalPage {\n  constructor(\n    public navParams: NavParams,\n    private aCtrl: AlertController,\n    private vCtrl: ViewController,\n    private afDatabase: AngularFireDatabase,\n    private aes: AES256,\n    private toast: ToastController\n  ) {}\n  listingData: any;\n  cardName: any;\n  CVC: any;\n  cardNo: any;\n  expiry: any;\n\n  ionViewWillLoad() {\n    const ticket = this.navParams.get(\"ticket\");\n    this.listingData = ticket;\n    console.log(ticket);\n    this.useExistingCard();\n  }\n\n  close() {\n    this.vCtrl.dismiss();\n  }\n\n  useExistingCard() {\n    var key = this.listingData.userId;\n    this.afDatabase\n      .object(`user/${key}`)\n      .snapshotChanges()\n      .subscribe(snapshot => {\n        var allData = snapshot.payload.val();\n        var value = Object.keys(allData);\n        var cardKey = value[0];\n        this.afDatabase\n          .object(`user/${key}/${cardKey}`)\n          .snapshotChanges()\n          .subscribe(async snapshot => {\n            const CardNo = snapshot.payload.child(`Card`).val();\n            const cardExpiry = snapshot.payload.child(`Expiry`).val();\n            const Holder = snapshot.payload.child(`Holder`).val();\n            const Key: string = snapshot.payload.child(`Key`).val();\n            const IV: string = snapshot.payload.child(`IV`).val();\n            var cardNoPlainText: string;\n            var cardExpiryPlainText: string;\n            var cardHolderPlainText: string;\n            await this.aes\n              .decrypt(Key, IV, CardNo)\n              .then(card => (cardNoPlainText = card))\n              .catch((error: any) => console.log(error));\n\n            await this.aes\n              .decrypt(Key, IV, cardExpiry)\n              .then(exp => (cardExpiryPlainText = exp))\n              .catch((error: any) => console.log(error));\n\n            await this.aes\n              .decrypt(Key, IV, Holder)\n              .then(holder => (cardHolderPlainText = holder))\n              .catch((error: any) => console.log(error));\n\n            var CardSubStr = cardNoPlainText.toString().substr(16);\n            let alert = this.aCtrl.create({\n              title: \"Payment\",\n              message:\n                \"Use card ending in\" + \" XXXX-X\"+CardSubStr+\" \"+\"for payment?\",\n              buttons: [\n                {\n                  text: \"NO\",\n                  role: \"cancel\",\n                  handler: () => {\n                    console.log(\"Cancel clicked\");\n                  }\n                },\n                {\n                  text: \"YES\",\n                  handler: () => {\n                    this.cardName = cardHolderPlainText;\n                    this.cardNo = cardNoPlainText;\n                    this.expiry = cardExpiryPlainText;\n                  }\n                }\n              ]\n            });\n            alert.present();\n          });\n      });\n  }\n\n  processPayment() {\n    if (this.cardNo.length != 19){\n    this.toast.create({message:'Card number should be 16 digits', duration:2000, position:'middle'}).present() \n    }else{\n    console.log(this.listingData.userId);\n    var transactionRef = [\n      {\n        Seller: this.listingData.sellerId,\n        TicketRef: this.listingData.ticketRef,\n        Buyer: this.listingData.userId,\n        Price: this.listingData.price,\n        SellerPayout: this.listingData.payout,\n        ttRevenue: this.listingData.charge,\n        PayeeAccountNo: this.listingData.payoutAccount,\n        Payout: this.listingData.payout\n      }\n    ];\n\n    var transRefNo = this.afDatabase\n      .list(`transactions`)\n      .push(transactionRef[0]).key;\n    var buyerRef = [\n      {\n        transactionRef: transRefNo,\n        TicketRef: this.listingData.ticketRef,\n        Paid: this.listingData.price,\n        FileUrl: \"www.firebase.com\"\n      }\n    ];\n\n    var sellerRef = [\n      {\n        Artist: this.listingData.artist,\n        transactionRef: transRefNo,\n        TicketRef: this.listingData.ticketRef,\n        Payout: this.listingData.payout,\n        Status: \"Pending\"\n      }\n    ];\n\n    var saleArchive = [\n      {\n        Seller: this.listingData.sellerId,\n        Event: this.listingData.artist,\n        Location: this.listingData.location,\n        Long: this.listingData.long,\n        Lat: this.listingData.lat,\n        Time: this.listingData.time,\n        Date: this.listingData.date,\n        Buyer: this.listingData.userId,\n        Price: this.listingData.price,\n        Payout: this.listingData.payout,\n        transactionRef: transRefNo\n      }\n    ];\n\n    console.log(transactionRef, buyerRef, transRefNo);\n    this.afDatabase\n      .list(`ticketsBought/${this.listingData.userId}`)\n      .push(buyerRef[0]);\n    this.afDatabase\n      .list(`ticketsSold/${this.listingData.userId}`)\n      .push(sellerRef[0]);\n    this.afDatabase\n      .object(`saleArchive/${this.listingData.ticketRef}`)\n      .set(saleArchive[0]);\n    // Need to remove the ticket from basket after the data has been sent to the other tables. //\n    this.close();\n  }\n}\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/payment-modal/payment-modal.ts"],"sourceRoot":""}