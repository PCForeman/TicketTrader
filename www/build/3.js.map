{"version":3,"sources":["../../src/pages/payment-modal/payment-modal.module.ts","../../src/pages/payment-modal/payment-modal.ts"],"names":[],"mappings":"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","file":"3.js","sourcesContent":["import { NgModule } from \"@angular/core\";\nimport { IonicPageModule } from \"ionic-angular\";\nimport { PaymentModalPage } from \"./payment-modal\";\n\n@NgModule({\n  declarations: [PaymentModalPage],\n  imports: [IonicPageModule.forChild(PaymentModalPage)]\n})\nexport class PaymentModalPageModule {}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/payment-modal/payment-modal.module.ts","import { Component } from \"@angular/core\";\r\nimport {\r\n  IonicPage,\r\n  NavParams,\r\n  ViewController,\r\n  AlertController,\r\n  ToastController\r\n} from \"ionic-angular\";\r\nimport { AngularFireDatabase } from \"angularfire2/database\";\r\nimport { AES256 } from \"@ionic-native/aes-256\";\r\n\r\n@IonicPage()\r\n@Component({\r\n  selector: \"page-payment-modal\",\r\n  templateUrl: \"payment-modal.html\"\r\n})\r\nexport class PaymentModalPage {\r\n  constructor(\r\n    public navParams: NavParams,\r\n    private aCtrl: AlertController,\r\n    private vCtrl: ViewController,\r\n    private afDatabase: AngularFireDatabase,\r\n    private aes: AES256,\r\n    private toast: ToastController\r\n  ) {}\r\n  listingData: any;\r\n  cardName: any;\r\n  CVC: any;\r\n  cardNo: any;\r\n  expiry: any;\r\n\r\n  ionViewWillLoad() {\r\n    const ticket = this.navParams.get(\"ticket\");\r\n    this.listingData = ticket;\r\n    console.log(ticket);\r\n    this.useExistingCard();\r\n  }\r\n\r\n  close() {\r\n    this.vCtrl.dismiss();\r\n  }\r\n\r\n  useExistingCard() {\r\n    var key = this.listingData.userId;\r\n    this.afDatabase\r\n      .object(`user/${key}`)\r\n      .snapshotChanges()\r\n      .subscribe(snapshot => {\r\n        var allData = snapshot.payload.val();\r\n        var value = Object.keys(allData);\r\n        var cardKey = value[0];\r\n        this.afDatabase\r\n          .object(`user/${key}/${cardKey}`)\r\n          .snapshotChanges()\r\n          .subscribe(async snapshot => {\r\n            const CardNo = snapshot.payload.child(`Card`).val();\r\n            const cardExpiry = snapshot.payload.child(`Expiry`).val();\r\n            const Holder = snapshot.payload.child(`Holder`).val();\r\n            const Key: string = snapshot.payload.child(`Key`).val();\r\n            const IV: string = snapshot.payload.child(`IV`).val();\r\n            var cardNoPlainText: string;\r\n            var cardExpiryPlainText: string;\r\n            var cardHolderPlainText: string;\r\n            await this.aes\r\n              .decrypt(Key, IV, CardNo)\r\n              .then(card => (cardNoPlainText = card))\r\n              .catch((error: any) => console.log(error));\r\n\r\n            await this.aes\r\n              .decrypt(Key, IV, cardExpiry)\r\n              .then(exp => (cardExpiryPlainText = exp))\r\n              .catch((error: any) => console.log(error));\r\n\r\n            await this.aes\r\n              .decrypt(Key, IV, Holder)\r\n              .then(holder => (cardHolderPlainText = holder))\r\n              .catch((error: any) => console.log(error));\r\n\r\n            var CardSubStr = cardNoPlainText.toString().substr(16);\r\n            let alert = this.aCtrl.create({\r\n              title: \"Payment\",\r\n              message:\r\n                \"Use card ending in\" +\r\n                \" XXXX-X\" +\r\n                CardSubStr +\r\n                \" \" +\r\n                \"for payment?\",\r\n              buttons: [\r\n                {\r\n                  text: \"NO\",\r\n                  role: \"cancel\",\r\n                  handler: () => {\r\n                    console.log(\"Cancel clicked\");\r\n                  }\r\n                },\r\n                {\r\n                  text: \"YES\",\r\n                  handler: () => {\r\n                    this.cardName = cardHolderPlainText;\r\n                    this.cardNo = cardNoPlainText;\r\n                    this.expiry = cardExpiryPlainText;\r\n                  }\r\n                }\r\n              ]\r\n            });\r\n            alert.present();\r\n          });\r\n      });\r\n  }\r\n\r\n  processPayment() {\r\n    if (this.cardNo.length != 19) {\r\n      this.toast\r\n        .create({\r\n          message: \"Card number should be 16 digits\",\r\n          duration: 2000,\r\n          position: \"middle\"\r\n        })\r\n        .present();\r\n    } else {\r\n      console.log(this.listingData.userId);\r\n      var transactionRef = [\r\n        {\r\n          Seller: this.listingData.sellerId,\r\n          TicketRef: this.listingData.ticketRef,\r\n          Buyer: this.listingData.userId,\r\n          Price: this.listingData.price,\r\n          SellerPayout: this.listingData.payout,\r\n          ttRevenue: this.listingData.charge,\r\n          PayeeAccountNo: this.listingData.payoutAccount,\r\n          Payout: this.listingData.payout\r\n        }\r\n      ];\r\n\r\n      var transRefNo = this.afDatabase\r\n        .list(`transactions`)\r\n        .push(transactionRef[0]).key;\r\n      var buyerRef = [\r\n        {\r\n          transactionRef: transRefNo,\r\n          TicketRef: this.listingData.ticketRef,\r\n          Paid: this.listingData.price,\r\n          FileUrl: \"www.firebase.com\"\r\n        }\r\n      ];\r\n\r\n      var sellerRef = [\r\n        {\r\n          Artist: this.listingData.artist,\r\n          transactionRef: transRefNo,\r\n          TicketRef: this.listingData.ticketRef,\r\n          Payout: this.listingData.payout,\r\n          Status: \"Pending\"\r\n        }\r\n      ];\r\n\r\n      var saleArchive = [\r\n        {\r\n          Seller: this.listingData.sellerId,\r\n          Event: this.listingData.artist,\r\n          Location: this.listingData.location,\r\n          Long: this.listingData.long,\r\n          Lat: this.listingData.lat,\r\n          Time: this.listingData.time,\r\n          Date: this.listingData.date,\r\n          Buyer: this.listingData.userId,\r\n          Price: this.listingData.price,\r\n          Payout: this.listingData.payout,\r\n          transactionRef: transRefNo\r\n        }\r\n      ];\r\n\r\n      console.log(transactionRef, buyerRef, transRefNo);\r\n      this.afDatabase\r\n        .list(`ticketsBought/${this.listingData.userId}`)\r\n        .push(buyerRef[0]);\r\n      this.afDatabase\r\n        .list(`ticketsSold/${this.listingData.userId}`)\r\n        .push(sellerRef[0]);\r\n      this.afDatabase\r\n        .object(`saleArchive/${this.listingData.ticketRef}`)\r\n        .set(saleArchive[0]);\r\n      // Need to remove the ticket from basket after the data has been sent to the other tables. //\r\n      this.close();\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/payment-modal/payment-modal.ts"],"sourceRoot":""}